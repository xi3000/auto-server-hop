-- Auto Server Hop + GUI On/Off + Hiển thị số server đã hop
-- WARNING: Có thể vi phạm Roblox ToS nếu dùng trong game public. Dùng cẩn trọng.

local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local HOP_DELAY = 13
local MAX_SERVERS_FETCH = 100
local PLACE_ID = game.PlaceId
local LocalPlayer = Players.LocalPlayer
local RESET_AFTER = 50 -- Reset visitedServers sau 50 server đã hop

-- ========== TELEPORT DATA ==========
local teleportData = TeleportService:GetLocalPlayerTeleportData() or {}
local autoHopEnabled = teleportData.autoHopEnabled or false
local visitedServers = teleportData.visitedServers or {}
visitedServers[tostring(game.JobId)] = true
local hopCount = teleportData.hopCount or 0

-- ========== GUI ==========
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoHopGui"
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Nút ON/OFF
local Button = Instance.new("TextButton")
Button.Size = UDim2.new(0, 150, 0, 50)
Button.Position = UDim2.new(0.05, 0, 0.1, 0)
Button.BackgroundColor3 = autoHopEnabled and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(170, 0, 0)
Button.TextColor3 = Color3.fromRGB(255, 255, 255)
Button.TextScaled = true
Button.Text = autoHopEnabled and "AutoHop: ON" or "AutoHop: OFF"
Button.Parent = ScreenGui

-- Label hiển thị số server đã hop
local Label = Instance.new("TextLabel")
Label.Size = UDim2.new(0, 150, 0, 30)
Label.Position = UDim2.new(0.05, 0, 0.22, 0)
Label.BackgroundTransparency = 1
Label.TextColor3 = Color3.fromRGB(255, 255, 255)
Label.TextScaled = true
Label.Text = "Servers hopped: " .. hopCount
Label.Parent = ScreenGui

Button.MouseButton1Click:Connect(function()
    autoHopEnabled = not autoHopEnabled
    if autoHopEnabled then
        Button.Text = "AutoHop: ON"
        Button.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    else
        Button.Text = "AutoHop: OFF"
        Button.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    end
end)

-- ========== LOGIC ==========
local function safeWait(seconds)
    local t0 = tick()
    while tick() - t0 < seconds do
        task.wait(0.1)
    end
end

local function fetchServerList(cursor)
    local url = ("https://games.roblox.com/v1/games/%d/servers/Public?limit=%d"):format(PLACE_ID, MAX_SERVERS_FETCH)
    if cursor then url = url .. "&cursor=" .. cursor end
    local ok, res = pcall(function()
        return HttpService:GetAsync(url)
    end)
    if not ok then return nil end
    local decoded = HttpService:JSONDecode(res)
    return decoded.data, decoded.nextPageCursor
end

local function chooseServer()
    local cursor = nil
    for _ = 1, 5 do -- thử 5 trang
        local servers, nextCursor = fetchServerList(cursor)
        if servers then
            local candidates = {}
            for _, s in ipairs(servers) do
                local sid = s.id
                if sid and not visitedServers[sid] and tostring(sid) ~= tostring(game.JobId) then
                    table.insert(candidates, sid)
                end
            end
            if #candidates > 0 then
                return candidates[math.random(1, #candidates)]
            end
        end
        cursor = nextCursor
        if not cursor then break end
    end
    return nil
end

local function hop(serverId)
    if not serverId then return end
    visitedServers[serverId] = true
    hopCount = hopCount + 1
    Label.Text = "Servers hopped: " .. hopCount

    -- Reset visitedServers nếu đã hop đủ RESET_AFTER server
    if hopCount >= RESET_AFTER then
        visitedServers = {}
        visitedServers[tostring(game.JobId)] = true
        hopCount = 0
        Label.Text = "Servers hopped: " .. hopCount
    end

    -- truyền visitedServers và autoHopEnabled qua TeleportData
    local teleportInfo = {
        autoHopEnabled = autoHopEnabled,
        visitedServers = visitedServers,
        hopCount = hopCount
    }

    pcall(function()
        TeleportService:TeleportToPlaceInstance(
            PLACE_ID,
            serverId,
            LocalPlayer,
            teleportInfo
        )
    end)
end

-- MAIN LOOP
task.spawn(function()
    while true do
        safeWait(HOP_DELAY)
        if autoHopEnabled then
            local sid = chooseServer()
            if sid then
                hop(sid)
            else
                TeleportService:Teleport(PLACE_ID, LocalPlayer, {
                    autoHopEnabled = autoHopEnabled,
                    visitedServers = visitedServers,
                    hopCount = hopCount
                })
            end
        end
    end
end)
